module Test where

import Model
import Daml.Script
import qualified DA.Set as Set

-- Helpers

data TestParties = TestParties with
  hrManager: Party
  candidate: Party
  other: Party
  public: Party

setupTestParties: Script TestParties
setupTestParties = script do
  hrManager <- allocateParty "HR Manager"
  candidate <- allocateParty "Candidate"
  other <- allocateParty "OtherCandidate"
  public <- allocateParty "Public"
  return $ TestParties with
    hrManager
    candidate
    other
    public

canCreateJobOfferPublicState: Int -> Party -> Party -> Script (ContractId JobOfferPublicState)
canCreateJobOfferPublicState jobId hrManager public = do
  let jobApplicationCids = Set.empty
  submit hrManager $ createCmd $ JobOfferPublicState with jobId; hrManager; public; jobApplicationCids

cantCreateJobOfferPublicState: Int -> Party -> Party -> Script ()
cantCreateJobOfferPublicState jobId hrManager public = do
  let jobApplicationCids = Set.empty
  submitMustFail hrManager $ createCmd $ JobOfferPublicState with jobId; hrManager; public; jobApplicationCids

canCreateJobOffer: Int -> Party -> Party -> Script (ContractId JobOffer)
canCreateJobOffer jobId hrManager public =
  submit hrManager $ createCmd $ JobOffer with jobId; hrManager; public

cantCreateJobOffer: Int -> Party -> Party -> Script ()
cantCreateJobOffer jobId hrManager public =
  submitMustFail hrManager $ createCmd $ JobOffer with jobId; hrManager; public

canCreateJobApplication: Int -> Party -> Party -> Text -> Script (ContractId JobApplication)
canCreateJobApplication jobId candidate hrManager summary =
  submitMulti [candidate, hrManager] [] $ createCmd $ JobApplication with jobId; candidate; hrManager; summary

cantCreateJobApplication: Int -> Party -> Party -> Text -> Script ()
cantCreateJobApplication jobId candidate hrManager summary =
  submitMultiMustFail [candidate, hrManager] [] $ createCmd $ JobApplication with jobId; candidate; hrManager; summary

canApplyToJobOffer: ContractId JobOffer -> Party -> Text -> Party -> Script (ContractId JobApplication)
canApplyToJobOffer jobOfferCid candidate summary public =
  submitMulti [candidate] [public] $ exerciseCmd jobOfferCid NewJobApplication with candidate;summary

cantApplyToJobOffer: ContractId JobOffer -> Party -> Text -> Party -> Script ()
cantApplyToJobOffer jobOfferCid candidate summary public =
  submitMultiMustFail [candidate] [public] $ exerciseCmd jobOfferCid NewJobApplication with candidate;summary

canCreateJobContract: Party -> Party -> Script (ContractId JobContract)
canCreateJobContract hrManager employee =
  submitMulti [hrManager, employee] [] $ createCmd $ JobContract with hrManager; employee

cantCreateJobContract: Party -> Party -> Script ()
cantCreateJobContract hrManager employee =
  submitMultiMustFail [hrManager, employee] [] $ createCmd $ JobContract with hrManager; employee

canAcceptJobApplication: ContractId JobApplication -> Party -> Script (ContractId JobContract)
canAcceptJobApplication jobApplicationCid hrManager =
  submit hrManager $ exerciseCmd jobApplicationCid Accept

cantAcceptJobApplication: ContractId JobApplication -> Party -> Script ()
cantAcceptJobApplication jobApplicationCid hrManager =
  submitMustFail hrManager $ exerciseCmd jobApplicationCid Accept

canRejectJobApplication: ContractId JobApplication -> Party -> Script ()
canRejectJobApplication jobApplicationCid hrManager =
  submit hrManager $ exerciseCmd jobApplicationCid Reject

cantRejectJobApplication: ContractId JobApplication -> Party -> Script ()
cantRejectJobApplication jobApplicationCid hrManager =
  submitMustFail hrManager $ exerciseCmd jobApplicationCid Reject

canDeclineJobApplication: ContractId JobApplication -> Party -> Party -> Script ()
canDeclineJobApplication jobApplicationCid candidate public =
  submitMulti [candidate] [public] $ exerciseCmd jobApplicationCid Decline

cantDeclineJobApplication: ContractId JobApplication -> Party -> Script ()
cantDeclineJobApplication jobApplicationCid candidate =
  submitMustFail candidate $ exerciseCmd jobApplicationCid Decline

queryNbrOfJobApplications : Party -> (Party, Int) -> Script (Optional Int)
queryNbrOfJobApplications public (hrManager, jobId) = do
  queryPublicStateResult <- queryContractKey @JobOfferPublicState public (hrManager, jobId)
  let maybePublicState = snd <$> queryPublicStateResult
  let nbrOfJobApplications = (\state -> Set.size state.jobApplicationCids) <$> maybePublicState
  return nbrOfJobApplications

-- Scenarios

-- hr manager `can` create multiple job offer public states using different jobId.
scenario0: Script ()
scenario0 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let jobId1 = 1
  canCreateJobOfferPublicState jobId1 hrManager public
  -- hr manager `cant` create multiple job offer public states using same jobId.
  cantCreateJobOfferPublicState jobId1 hrManager public
  let jobId2 = 2
  canCreateJobOfferPublicState jobId2 hrManager public
  pure ()

-- hr manager `can` create multiple job offers using different jobId.
scenario1: Script ()
scenario1 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let jobId1 = 1
  canCreateJobOffer jobId1 hrManager public
  -- hr manager `cant` create multiple job offers using same jobId.
  cantCreateJobOffer jobId1 hrManager public
  let jobId2 = 2
  canCreateJobOffer jobId2 hrManager public
  pure ()

-- candidate `can` apply to a job offer.
scenario2: Script ()
scenario2 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  canApplyToJobOffer jobOfferCid candidate summary public
  pure ()

-- candidate `cant` apply to a job offer twice.
scenario3: Script ()
scenario3 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  canApplyToJobOffer jobOfferCid candidate summary public
  cantApplyToJobOffer jobOfferCid candidate summary public
  -- once the job application is created we cannot create it again.
  cantCreateJobApplication jobId candidate hrManager summary
  pure ()

-- hr manager `can` accept a job application.
scenario4: Script ()
scenario4 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  canAcceptJobApplication jobApplicationCid hrManager
  pure ()

-- hr manager `cant` accept a job application twice.
scenario5: Script ()
scenario5 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  canAcceptJobApplication jobApplicationCid hrManager
  cantAcceptJobApplication jobApplicationCid hrManager
  -- once the job contract is created we cannot create it again.
  cantCreateJobContract hrManager candidate
  pure ()

-- candidate `cant` accept its own job application.
scenario6: Script ()
scenario6 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  cantAcceptJobApplication jobApplicationCid candidate
  pure ()

-- hr manager `cant` apply to a job offer.
scenario7: Script ()
scenario7 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  cantApplyToJobOffer jobOfferCid hrManager summary public
  pure ()

-- `cant` create contracts using same parties.
scenario8: Script ()
scenario8 = script do
  random <- allocateParty "Random"
  other <- allocateParty "Other"
  let jobId = 1
  canCreateJobOfferPublicState jobId random other
  cantCreateJobOffer jobId random random
  let summary = "CandidateCSV.pdf"
  cantCreateJobApplication jobId random random summary
  cantCreateJobContract random random

-- hr manager `can` reject a job application.
scenario9: Script ()
scenario9 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  canRejectJobApplication jobApplicationCid hrManager
  pure ()

-- hr manager `cant` reject a job application twice.
scenario10: Script ()
scenario10 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  canRejectJobApplication jobApplicationCid hrManager
  cantRejectJobApplication jobApplicationCid hrManager
  pure ()

-- candidate `cant` reject its own job application.
scenario11: Script ()
scenario11 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  cantRejectJobApplication jobApplicationCid candidate
  pure ()

-- candidate `can` decline a job application.
scenario12: Script ()
scenario12 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  canDeclineJobApplication jobApplicationCid candidate public
  pure ()

-- candidate `cant` decline a job application twice.
scenario13: Script ()
scenario13 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  canDeclineJobApplication jobApplicationCid candidate public
  cantDeclineJobApplication jobApplicationCid candidate
  pure ()

-- hr manager `cant` decline a job application.
scenario14: Script ()
scenario14 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let summary = "CandidateCSV.pdf"
  jobApplicationCid <- canApplyToJobOffer jobOfferCid candidate summary public
  cantDeclineJobApplication jobApplicationCid hrManager
  pure ()

-- public `can` observe when new job applications are registered/rejected to the job offer public state.
scenario15: Script ()
scenario15 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let other = testParties.other
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let (summary, otherSummary) = ("CandidateCSV.pdf", "OtherCandidateCSV.pdf")
  canApplyToJobOffer jobOfferCid candidate summary public
  jobApplicationCid <- canApplyToJobOffer jobOfferCid other otherSummary public
  -- public observes both registrations
  nbrOfJobApplications1 <- queryNbrOfJobApplications public (hrManager, jobId)  
  assertMsg "wrong nbr of job applications" $ nbrOfJobApplications1 == Some 2
  -- public observers application rejected
  canRejectJobApplication jobApplicationCid hrManager
  nbrOfJobApplications2 <- queryNbrOfJobApplications public (hrManager, jobId)  
  assertMsg "wrong nbr of job applications" $ nbrOfJobApplications2 == Some 1

-- upon accepting a job application, the rest should be archived and the job offer should be terminated
-- alog with the public state.
scenario16: Script ()
scenario16 = script do
  testParties <- setupTestParties
  let hrManager = testParties.hrManager
  let public = testParties.public
  let candidate = testParties.candidate
  let other = testParties.other
  let jobId = 1
  canCreateJobOfferPublicState jobId hrManager public
  jobOfferCid <- canCreateJobOffer jobId hrManager public
  let (summary, otherSummary) = ("CandidateCSV.pdf", "OtherCandidateCSV.pdf")
  canApplyToJobOffer jobOfferCid candidate summary public
  jobApplicationCid <- canApplyToJobOffer jobOfferCid other otherSummary public
  -- public observes both registrations
  nbrOfJobApplications1 <- queryNbrOfJobApplications public (hrManager, jobId)  
  assertMsg "wrong nbr of job applications" $ nbrOfJobApplications1 == Some 2
  -- public observers the rest of applications get rejected
  canAcceptJobApplication jobApplicationCid hrManager
  nbrOfJobApplications2 <- queryNbrOfJobApplications public (hrManager, jobId)  
  assertMsg "wrong nbr of job applications" $ nbrOfJobApplications2 == (None)
  pure ()
